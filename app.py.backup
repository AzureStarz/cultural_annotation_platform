from flask import Flask, render_template, request, jsonify, redirect, url_for
import json
import os
from datetime import datetime

app = Flask(__name__)

LANGUAGES = [
    'Arabic', 'Chinese', 'English', 'German',
    'Japanese', 'Korean', 'Russian',
    'Spanish', 'Thai', 'Vietnamese'
]

def load_examples(task_type, language):
    """Load examples from JSON file"""
    if task_type == 'judgment':
        file_path = f'completion_judgment/{language}_carb_samples.json'
    else:
        file_path = f'completion_writing/{language}_carb_samples.json'

    if not os.path.exists(file_path):
        return []

    with open(file_path, 'r', encoding='utf-8') as f:
        return json.load(f)

@app.route('/')
def index():
    """Main landing page"""
    return render_template('index.html', languages=LANGUAGES)

@app.route('/annotate', methods=['POST'])
def start_annotation():
    """Start annotation session"""
    annotator_id = request.form.get('annotator_id', '').strip()
    task_type = request.form.get('task_type')
    language = request.form.get('language')

    if not annotator_id:
        return render_template('index.html', languages=LANGUAGES,
                               error='Please enter your annotator ID')

    if not task_type or not language:
        return render_template('index.html', languages=LANGUAGES,
                               error='Please select both task type and language')

    examples = load_examples(task_type, language)
    if not examples:
        return render_template('index.html', languages=LANGUAGES,
                               error=f'No examples found for {language} in {task_type} task')

    return redirect(url_for('annotate_task',
                           task_type=task_type,
                           language=language,
                           annotator_id=annotator_id))

@app.route('/annotate/<task_type>/<language>')
def annotate_task(task_type, language):
    """Annotation interface"""
    annotator_id = request.args.get('annotator_id')
    example_idx = request.args.get('example_idx', 0, type=int)

    examples = load_examples(task_type, language)

    if example_idx >= len(examples):
        example_idx = 0

    current_example = examples[example_idx]

    if task_type == 'judgment':
        return render_template('judgment.html',
                             example=current_example,
                             example_idx=example_idx,
                             total_examples=len(examples),
                             annotator_id=annotator_id,
                             task_type=task_type,
                             language=language,
                             progress={})
    else:
        return render_template('writing.html',
                             example=current_example,
                             example_idx=example_idx,
                             total_examples=len(examples),
                             annotator_id=annotator_id,
                             task_type=task_type,
                             language=language,
                             progress={})

@app.route('/api/download_annotations', methods=['POST'])
def api_download_annotations():
    """API endpoint for downloading annotations as a file"""
    data = request.json

    annotator_id = data.get('annotator_id')
    task_type = data.get('task_type')
    language = data.get('language')
    annotations = data.get('annotations', {})

    if not annotator_id or not task_type or not language:
        return jsonify({'status': 'error', 'message': 'Missing required parameters'}), 400

    # Calculate progress info
    completed_count = len(annotations)
    timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')

    # Create the annotation data structure
    annotation_data = {
        'annotator_id': annotator_id,
        'task_type': task_type,
        'language': language,
        'timestamp': timestamp,
        'download_info': f'Includes {completed_count} annotated examples',
        'annotations': annotations,
        'annotations_count': completed_count
    }

    return jsonify({
        'status': 'success',
        'data': annotation_data,
        'filename': f'{annotator_id}_{task_type}_{language}_{timestamp}.json',
        'progress': f'Includes {completed_count} annotated examples'
    })

# Vercel serverless handler
handler = app

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8080, debug=True)
