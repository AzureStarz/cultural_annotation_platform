<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Writing Task - Example {{ example_idx + 1 }}/{{ total_examples }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}?v=1.0" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">
                <i class="fas fa-globe-americas me-2"></i>
                Cultural Alignment Platform
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text text-white me-3">
                    <i class="fas fa-user me-1"></i>
                    {{ annotator_id }}
                </span>
                <span class="navbar-text text-white">
                    <i class="fas fa-language me-1"></i>
                    {{ language }}
                </span>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 class="mb-0">
                                <i class="fas fa-tasks me-2 text-primary"></i>
                                Progress: Example {{ example_idx + 1 }} of {{ total_examples }}
                            </h4>
                            <a href="/" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-home me-1"></i>
                                Back to Home
                            </a>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar bg-success fw-bold"
                                 role="progressbar"
                                 style="width: {{ ((example_idx + 1) / total_examples) * 100 }}%">
                                {{ ((example_idx + 1) / total_examples) * 100 | round(1) }}%
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-10 mx-auto">
                <div class="card shadow-lg mb-4">
                    <div class="card-header bg-primary text-white py-4">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-clipboard-question fs-2 me-3"></i>
                            <div>
                                <h2 class="mb-0">Your Task</h2>
                                <small class="text-light">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Write a culturally-accurate completion for this prompt
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-5">
                        <div class="alert alert-light border-2">
                            <div class="row">
                                <div class="col-md-6">
                                    <h5 class="text-primary mb-3">
                                        <i class="fas fa-tag me-2"></i>
                                        <strong>Topic:</strong> {{ example.category | title }}
                                    </h5>
                                </div>
                                <div class="col-md-6">
                                    <h5 class="text-primary mb-3">
                                        <i class="fas fa-flag me-2"></i>
                                        <strong>Culture:</strong> {{ example.country }}
                                    </h5>
                                </div>
                            </div>
                        </div>

                        <div class="p-4 bg-light rounded-3 mb-4">
                            <h4 class="mb-3 text-dark">
                                <i class="fas fa-quote-left me-2 text-primary"></i>
                                Prompt
                            </h4>
                            <p class="lead fs-5 mb-0" style="line-height: 1.7;">
                                {{ example.prompt }}
                            </p>
                        </div>

                        <div class="alert alert-info border-0 mb-4">
                            <h5 class="alert-heading">
                                <i class="fas fa-lightbulb me-2"></i>
                                Instructions
                            </h5>
                            <ul class="mb-0">
                                <li>Write a completion that accurately reflects <strong>{{ example.country }}</strong> culture</li>
                                <li>Address the same topic/angle as the reference below</li>
                                <li>Sound natural to a native speaker</li>
                                <li>Avoid stereotypes and overgeneralizations</li>
                                <li>Be specific and provide details when possible</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="card shadow-lg mb-4">
                    <div class="card-header bg-info text-white py-4">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-book fs-2 me-3"></i>
                            <div>
                                <h2 class="mb-0">Reference Completion</h2>
                                <small class="text-light">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Use this for thematic reference only - don't copy it
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <div class="completion-box chosen">
                            <div class="completion-text">
                                {{ example.chosen[0] }}
                            </div>
                            <div class="completion-model">
                                <i class="fas fa-robot me-1"></i>
                                This is the AI's answer for reference
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card shadow-lg mb-4">
                    <div class="card-header bg-light py-4">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-edit fs-2 me-3 text-success"></i>
                            <div>
                                <h2 class="mb-0 text-success">Your Completion</h2>
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    This is where you write your culturally-accurate answer
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-5">
                        <div class="mb-4">
                            <label for="human_completion" class="form-label fs-4 fw-semibold">
                                <i class="fas fa-keyboard me-2"></i>
                                Write your completion below
                                <span class="badge bg-danger ms-2">Required</span>
                            </label>
                            <textarea class="form-control writing-textarea" id="human_completion" rows="10"
                                      placeholder="Write your culturally-accurate completion here...&#10;&#10;Things to consider:&#10;- Use examples that are specific to {{ example.country }} culture&#10;- Avoid vague statements&#10;- Include relevant cultural details&#10;- Write as if you're explaining to someone from this culture
                            " required></textarea>
                            <div class="form-text fs-6 mt-2">
                                <i class="fas fa-info-circle me-1"></i>
                                Aim for 2-5 sentences with specific cultural details and examples.
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="writing_notes" class="form-label fs-5 fw-semibold">
                                <i class="fas fa-sticky-note me-2"></i>
                                Notes (Optional)
                            </label>
                            <textarea class="form-control writing-textarea" id="writing_notes" rows="4"
                                      placeholder="Add any notes about your completion:&#10;- Why you chose certain examples&#10;- Any cultural context you considered&#10;- Sources or personal experiences you relied on&#10;- Any uncertainties you have
                            "></textarea>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                This helps us understand your reasoning.
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="alert alert-info border-0">
                                    <h5 class="alert-heading">
                                        <i class="fas fa-clock me-2"></i>
                                        Time (Optional)
                                    </h5>
                                    <p class="mb-2">How many minutes did you spend?</p>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="writing_time_minutes" min="0" max="60"
                                               placeholder="e.g., 10">
                                        <span class="input-group-text">minutes</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-5 gap-3">
                    {% if example_idx > 0 %}
                    <button type="button" class="btn btn-outline-secondary btn-nav"
                            onclick="previousExample()">
                        <i class="fas fa-arrow-left me-1"></i>
                        Previous Example
                    </button>
                    {% else %}
                    <div></div>
                    {% endif %}

                    <div class="text-center">
                        <small class="text-muted" id="autosave_status">
                            <i class="fas fa-save me-1"></i>
                            Progress auto-saved
                        </small>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-info btn-nav"
                                onclick="handleDownloadClick()" id="downloadBtn"
                                title="Download current annotations to your PC">
                            <i class="fas fa-download me-1"></i>
                            Download
                        </button>
                        {% if example_idx + 1 == total_examples %}
                        <button type="button" class="btn btn-success btn-nav"
                                onclick="nextExample()" id="nextBtn">
                            <span id="nextBtnText">Submit All Completions</span>
                            <i class="fas fa-check-circle ms-1"></i>
                        </button>
                        {% else %}
                        <button type="button" class="btn btn-success btn-nav"
                                onclick="nextExample()" id="nextBtn">
                            <span id="nextBtnText">Next Example</span>
                            <i class="fas fa-arrow-right ms-1"></i>
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="autosave-indicator" id="autosaveIndicator">
        <i class="fas fa-save me-1"></i>
        Auto-saving...
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/writing.js') }}"></script>
    <script>
        const annotatorId = "{{ annotator_id }}";
        const taskType = "{{ task_type }}";
        const language = "{{ language }}";
        const exampleId = "{{ example.id }}";
        const exampleIdx = {{ example_idx }};
        const totalExamples = {{ total_examples }};
        const progress = {{ progress | tojson | safe }};

        function initializeProgress() {
            if (progress && progress[exampleId]) {
                const saved = progress[exampleId];
                if (saved.human_completion) {
                    document.getElementById('human_completion').value = saved.human_completion;
                }
                if (saved.notes) {
                    document.getElementById('writing_notes').value = saved.notes;
                }
                if (saved.annotation_time_seconds) {
                    document.getElementById('writing_time_minutes').value = Math.max(1, Math.round(saved.annotation_time_seconds / 60));
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            initializeProgress();
        });

        let autoSaveTimer = null;

        function triggerAutoSave() {
            if (autoSaveTimer) {
                clearTimeout(autoSaveTimer);
            }
            autoSaveTimer = setTimeout(autoSave, 2000);
        }

        document.getElementById('human_completion').addEventListener('input', triggerAutoSave);
        document.getElementById('writing_notes').addEventListener('input', triggerAutoSave);
        document.getElementById('writing_time_minutes').addEventListener('input', triggerAutoSave);
    </script>
</body>
</html>
